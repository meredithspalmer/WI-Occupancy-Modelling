################################
###### Species Selection #######
################################

# Project: WI Occupancy Range Wide Trends
# This file contains code to select species for final model, including 
# 1) removing non-mammals, 
# 2) ranking by data availability, and 
# 3) calculating SIH scores 
# It also produces a cleaned data set ready for ingestion in downstream analyses

# Run 1x

# Set worksace ----------------------------------------------------------------

rm(list=ls()); gc()
setwd("/gpfs/gibbs/pi/jetz/projects/WildlifeInsights")
set.seed(123)

library(data.table)
library(dplyr)
library(lubridate)
library(ggplot2)
library(taxize)
library(terra)
library(sf)
library(countrycode)
library(rnaturalearth)
library(rnaturalearthdata)  
library(purrr)
library(tidyterra)


# Load data -------------------------------------------------------------------

dat_seq    <- fread("WI data/sequences_updated_20240710.csv")
dat_images <- fread("WI data/images_updated_20240714.csv")

keep_cols <- c("project_id", "deployment_location_id", "record_date",
               "sensor_start_date_and_time", "sensor_end_date_and_time",
               "latitude", "longitude", "class", "sp_binomial")

dat_seq <- dat_seq[
  , .(
    project_id                  = project_id,
    deployment_location_id      = deployment_location_id,
    record_date                 = as.IDate(sequence_date),   
    sensor_start_date_and_time  = sensor_start_date_and_time,
    sensor_end_date_and_time    = sensor_end_date_and_time,
    latitude                    = latitude,
    longitude                   = longitude,
    class                       = class,
    sp_binomial              = sp_binomial
  )
][
  , (keep_cols) := lapply(.SD, function(x) if(is.character(x)) trimws(x) else x), 
  .SDcols = keep_cols
]

dat_images <- dat_images[
  Accepted_MOL != "Accepted_MOL" & !is.na(Accepted_MOL), #rm header as row
  .(
    project_id                  = project_id,
    deployment_location_id      = deployment_location_id,
    record_date                 = as.IDate(photo_date),
    sensor_start_date_and_time  = sensor_start_date_and_time,
    sensor_end_date_and_time    = sensor_end_date_and_time,
    latitude                    = as.numeric(latitude),
    longitude                   = as.numeric(longitude),
    class                       = class,
    sp_binomial                 = Accepted_MOL
  )
]

# Combine datasets
all_dat <- rbindlist(list(dat_seq, dat_images), use.names = TRUE, fill = TRUE)
all_dat <- all_dat[
  !is.na(record_date),   
][
  , `:=`(
    sensor_start_date = as.IDate(sensor_start_date_and_time),
    sensor_end_date   = as.IDate(sensor_end_date_and_time),
    record_date       = as.IDate(record_date)
  )
][
  , .(project_id, deployment_location_id, record_date,
      sensor_start_date, sensor_end_date,
      latitude, longitude, class, sp_binomial)
]

all_dat$proj_depl <- paste(all_dat$project_id, all_dat$deployment_location_id)
all_dat <- all_dat[year(record_date) >= 2000]  
full_dat <- all_dat


# Effort per species ----------------------------------------------------------

# Number of records 
species_counts <- all_dat[, .N, by = sp_binomial]
setnames(species_counts, "N", "record_count") 
setorder(species_counts, -record_count)
hist(species_counts$record_count)
head(species_counts); tail(species_counts)

# Number of deployments
species_counts[all_dat[, .(unique_deployments = uniqueN(proj_depl)), by = sp_binomial],
  unique_deployments := i.unique_deployments, on = "sp_binomial"]

# Avg. Counts per Deployment 
species_counts[, avg_records_per_deployment := round(record_count / unique_deployments, 1)]


# Subset mammals --------------------------------------------------------------

species_counts[, class := NA_character_]
unique_sp <- unique(species_counts$sp_binomial)

cls <- classification(unique_sp, db = "ncbi", rows = 1) 
cls_df <- data.table(sp_binomial = names(cls),
                     tax_class  = sapply(cls, function(x) {
                       if (is.data.frame(x) && "class" %in% x$rank) {
                         x$name[x$rank == "class"]
                         } else {
                           NA_character_
                           }}))
species_counts <- merge(species_counts, cls_df, by = "sp_binomial", all.x = TRUE)
table(species_counts$tax_class)

# Examine NAs 
nrow(species_counts[is.na(species_counts$tax_class),])
View(species_counts[is.na(species_counts$tax_class),])

# Rename (here and in all_dat)
species_counts[species_counts$sp_binomial == "Cephalophus ogilbyi ssp. brookei",]$sp_binomial <- "Cephalophus ogilbyi"
all_dat[all_dat$sp_binomial == "Cephalophus ogilbyi ssp. brookei",]$sp_binomial <- "Cephalophus ogilbyi"

species_counts[species_counts$sp_binomial == "Cercopithecus petaurista ssp. buettikoferi",]$sp_binomial <- "Cercopithecus petaurista"
all_dat[all_dat$sp_binomial == "Cercopithecus petaurista ssp. buettikoferi",]$sp_binomial <- "Cercopithecus petaurista"

species_counts[species_counts$sp_binomial == "Lupulella adustus",]$sp_binomial <- "Lupulella adusta"
all_dat[all_dat$sp_binomial == "Lupulella adustus",]$sp_binomial <- "Lupulella adusta" 

species_counts[species_counts$sp_binomial == "Ursus U. arctos",]$sp_binomial <- "Ursus arctos"
all_dat[all_dat$sp_binomial == "Ursus U. arctos",]$sp_binomial <- "Ursus arctos"

species_counts[species_counts$sp_binomial == "Muntiacus rooseveltorum/truongsonensis"]$sp_binomial <- "Muntiacus rooseveltorum"
all_dat[all_dat$sp_binomial == "Muntiacus rooseveltorum/truongsonensis"]$sp_binomial <- "Muntiacus rooseveltorum"

mammals <- c("Alouatta arctoidea", 
             "Bdeogale omnivora",
             "Cebus cuscinus", 
             "Cebus malitiosus",
             "Cephalophus ogilbyi",
             "Cercopithecus petaurista",
             "Cercocebus sanjei", 
             "Dasyprocta croconota", 
             "Dasyprocta iacki", 
             "Dasyprocta mexicana", 
             "Dasyprocta prymnolopha", 
             "Dasyprocta variegata", 
             "Eliurus penicillatus",
             "Eliurus petteri",
             "Epixerus ebii",
             "Euoticus pallidus",
             "Euxerus erythropus",
             "Funisciurus congicus", 
             "Funisciurus isabella",
             "Hydrochoerus isthmius",
             "Hystrix pumila",
             "Lupulella adusta",
             "Lupulella mesomelas",
             "Macropus parryi",
             "Macrotarsomys petteri",
             "Martes gwatkinsii",
             "Microsciurus santanderensis",
             "Mungos gambianus",
             "Muntiacus rooseveltorum",
             "Paramelomys naso",
             "Paraxerus boehmi",
             "Paraxerus lucifer",
             "Paraxerus palliatus",
             "Peromyscus melanurus",
             "Plecturocebus aureipalatii",
             "Plecturocebus ornatus",
             "Presbytis siamensis",
             "Proechimys canicollis",
             "Proechimys chrysaeolus",
             "Proechimys oconnelli",
             "Saguinus tripartitus",
             "Sciurus aestuans",
             "Sciurus spadiceus",
             "Sciurus stramineus",
             "Semnopithecus dussumieri",
             "Sminthopsis fuliginosus",
             "Sus ahoenobarbus",
             "Sylvilagus cognatus",
             "Tragulus nigricans",
             "Ursus arctos",
             "Urva fusca",
             "Urva smithii",
             "Urva vitticolla")
species_counts[species_counts$sp_binomial %in% mammals,]$tax_class <- "Mammalia"             

birds <- c("Aramides calopterus",
           "Aramides saracura",
           "Arborophila davidi", 
           "Ardea albus", 
           "Ardea modestus",
           "Ardea sumatrana",
           "Atlapetes blancae", 
           "Bostrychia olivacea", 
           "Brachypteracias squamiger", 
           "Calamonastes stierlingi",
           "Campocolinus coqui", 
           "Celeus ochraceus", 
           "Chloropicus spodocephalus", 
           "Ciccaba albitarsis", 
           "Cinnyris osea", 
           "Cisticola hunteri", 
           "Colaptes cafer", 
           "Coracias affinis", 
           "Cossypha heinrichi", 
           "Coua olivaceiceps", 
           "Crax pinima", 
           "Cyanocorax colliei", 
           "Cyanocorax morio",
           "Cynanthus cynanthus latirostris", 
           "Cyornis lemprieri", 
           "Dendroica aestiva",
           "Dyaphorophyia ansorgei",
           "Gallinago andina",
           "Gallinago nemoricola",
           "Gelochelidon macrotarsa",
           "Gymnoris pyrgita",
           "Hydrornis irena",
           "Hylatomus pileatus",
           "Hypnelus ruficollis",
           "Ianthocincla konkakinhensis",
           "Icterus bullockiorum",
           "Leistes loyca",
           "Leuconotopicus borealis",
           "Lophorina paradisea",
           "Malacoptila mystacalis",
           "Myophonus horsfieldii",
           "Nectarinia purpureiventris",
           "Nicator gularis",
           "Ortalis araucuan",
           "Ortalis columbiana",
           "Ortalis superciliaris",
           "Otus fuliginosus",
           "Passer pyrrhonotus",
           "Penelope ortoni",
           "Penelope perspicax",
           "Phalcoboenus chimango",
           "Pheugopedius fasciatoventris",
           "Pseudibis davisoni",
           "Pseudibis gigantea",
           "Psophia dextralis",
           "Psophia obscura",
           "Psophia ochroptera",
           "Pterocles decoratus",
           "Pyrope pyrope",
           "Rallus madagascariensis",
           "Rhipidura nigritorquis",
           "Rhipidura phoenicura",
           "Sericornis NULL",
           "Setophaga graysoni",
           "Spilopelia suratensis",
           "Stachyris herberti",
           "Sugomel nigrum",
           "Thaumatibis gigantea",
           "Threskiornis bernieri",
           "Tolmomyias viridiceps",
           "Trochalopteron ngoclinhense",
           "Turnix maculosus",
           "Upupa marginata",
           "Urile penicillatus",
           "Urocissa whiteheadi",
           "Urosphena neumanni",
           "Vanellus senegallus")
species_counts[species_counts$sp_binomial %in% birds,]$tax_class <- "Aves"   

# Remove non-mammals
unique(species_counts$tax_class)
species_counts <- species_counts[species_counts$tax_class == "Mammalia",]
all_dat <- all_dat[all_dat$sp_binomial %in% unique(species_counts$sp_binomial),]
unique(species_counts$tax_class)


# Add species data ------------------------------------------------------------

# Add species common names
unique_sp <- unique(species_counts$sp_binomial)
common_list <- sci2comm(unique_sp, db = "ncbi", simplify = TRUE)
common_dt <- data.table(sp_binomial = unique_sp,
                        common_name = sapply(common_list, function(x) if (length(x) > 0) x[1] else NA_character_))
species_counts <- merge(species_counts, common_dt, by = "sp_binomial", all.x = TRUE)
setcolorder(species_counts, c("sp_binomial", "common_name", "record_count", "tax_class"))

# Add continent to all_dat
world_countries <- ne_countries(scale = "medium", returnclass = "sf")
points_sf <- st_as_sf(all_dat, coords = c("longitude", "latitude"), 
                      crs = 4326, remove = FALSE)  
joined <- st_join(points_sf, 
                  world_countries["continent"], 
                  join = st_intersects, 
                  left = TRUE)
all_dat[, continent := joined$continent]

# Examine NAs -> most are coastal, so assign to nearest landmass 
all_dat[is.na(continent),]

nrow(na_rows <- which(is.na(all_dat$continent)))
na_points_sf <- points_sf[na_rows, ]
nearest_idx <- st_nearest_feature(na_points_sf, world_countries)
nearest_continents <- world_countries$continent[nearest_idx]
all_dat[na_rows, continent := nearest_continents]

# Quick checks 
table(all_dat$continent, useNA = "always")
head(all_dat[, .(sp_binomial, latitude, longitude, continent)])

# Add continent to species_counts
# Primary (most frequent) continent per species
species_continents <- all_dat[!is.na(continent), .(
  primary_continent = names(sort(table(continent), decreasing = TRUE))[1]
), by = sp_binomial]

# Merge 
species_counts <- merge(species_counts, species_continents, by = "sp_binomial",
                        all.x = TRUE)


# MMD range map for species? --------------------------------------------------

# Raster directory
# (I believe the first has habitat suitability and the second on the range outline, but need
# only the range outline)
raster_dir_1 <- "/gpfs/gibbs/pi/jetz/data/species_datasets/rangemaps/mammals/mdd_mammals/rasters_cea"
raster_dir_2 <- "/gpfs/gibbs/pi/jetz/data/species_datasets/rangemaps/mammals/mdd_mammals/rasters"

# Raster exists yes/no
species_counts[, has_raster := {
  file_name <- paste0(gsub(" ", "_", sp_binomial), ".tif")
  fifelse(
    file.exists(file.path(raster_dir_1, file_name)) |
      file.exists(file.path(raster_dir_2, file_name)),
    "YES", "NO"
  )
}]

# Explore missing results
View(species_counts[species_counts$has_raster == "NO",])
missing_rasters <- unique(species_counts[species_counts$has_raster == "NO",]$sp_binomial)

# Clean
species_counts <- species_counts[!species_counts$has_raster == "NO",]
all_dat <- all_dat[!all_dat$sp_binomial %in% missing_rasters,]


# Calculate SIH score ---------------------------------------------------------

# Oliver et al. 2023 - Camera trapping expands the view into global biodiversity and its change 
# Spatial biodiversity data coverage was assessed using the SII. The SII estimates the proportion of a species’ range with observations in a given year. For each species, their expected range was intersected with a 110 × 110 km equal area grid to determine the number of grid cells where they are expected to occur he SII is then computed as the proportion of expected occupied grid cells with observations in a given year. For example, a value of 0.5 indicates that 50% of grid cells in which a species is expected to occur had data. It is important to note that values are not necessarily expected to approach the maximum value of 1 as this would constitute complete coverage of species range in a single year. Even for well-documented species, such as birds, the global mean in annual data coverage is less than 20% [9].

# Raster directories
raster_dir_1 <- "/gpfs/gibbs/pi/jetz/data/species_datasets/rangemaps/mammals/mdd_mammals/rasters_cea"
raster_dir_2 <- "/gpfs/gibbs/pi/jetz/data/species_datasets/rangemaps/mammals/mdd_mammals/rasters"

# CEA projection & global extent
cea_crs <- "+proj=cea +lat_ts=30 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"
ext_global <- ext(-17000000, 17000000, -8900000, 8900000)

# Create the 110 km grid template (global)
grid_110 <- rast(ext = ext_global, resolution = 110000, crs = cea_crs)
values(grid_110) <- 1:ncell(grid_110)  # unique cell IDs (1-based)

# Prepare deployment points once (outside loop)
deployments <- unique(full_dat[, .(proj_depl, latitude, longitude)])
deploy_sf <- st_as_sf(deployments, coords = c("longitude", "latitude"), crs = 4326)
deploy_vect <- vect(st_transform(deploy_sf, cea_crs))

# Assign each deployment to its 110 km cell ID (done once)
deploy_cell_ids <- extract(grid_110, deploy_vect, method = "simple")[[1]]
deployments[, grid_id_110km := deploy_cell_ids]

# Initialize results table
results <- data.table(
  sp_binomial       = character(),
  source_dir        = character(),
  total_range_110km = integer(),
  sampled_110km     = integer()
)

# Species list
unique_species <- unique(species_counts$sp_binomial)

# Main loop over species
for (sp in unique_species) {
  
  # Find raster file
  file_name <- paste0(gsub(" ", "_", sp), ".tif")
  path <- file.path(raster_dir_1, file_name)
  source_used <- "cea"
  
  if (!file.exists(path)) {
    path <- file.path(raster_dir_2, file_name)
    source_used <- "plain"
  }
  
  if (!file.exists(path)) {
    message("No raster found for ", sp, " in either directory")
    next
  }
  
  # Load fine-resolution range raster
  r <- rast(path)
  
  # Reproject to exact match with grid_110 CRS
  r_aligned <- project(r, cea_crs, method = "near")
  
  # Step 1: Try global resampling with "sum" (most accurate)
  agg <- resample(r_aligned, grid_110, method = "sum")
  
  # Check if successful
  mm <- minmax(agg)
  agg_sum_global <- global(agg, "sum", na.rm = TRUE)$sum
  
  success <- !all(is.nan(mm)) && !all(is.na(mm)) && !is.na(agg_sum_global) && agg_sum_global > 0
  
  if (!success) {
    message("Species ", sp, ": 'sum' on global grid empty → trying 'near'")
    agg <- resample(r_aligned, grid_110, method = "near")
    
    mm <- minmax(agg)
    agg_sum_global <- global(agg, "sum", na.rm = TRUE)$sum
    success <- !all(is.nan(mm)) && !all(is.na(mm)) && !is.na(agg_sum_global) && agg_sum_global > 0
  }
  
  # Step 2: If both global methods fail → fallback to local cropping + resampling
  if (!success) {
    message("Species ", sp, ": global methods failed → falling back to local crop + resampling")
    
    # Buffer around source extent
    buf <- 150000  # meters
    e_src <- ext(r_aligned)
    e_buf <- ext(xmin(e_src) - buf, xmax(e_src) + buf,
                 ymin(e_src) - buf, ymax(e_src) + buf)
    
    # Local target grid
    local_grid <- crop(grid_110, e_buf, snap = "near", extend = TRUE)
    
    # Resample onto local grid
    agg_local <- resample(r_aligned, local_grid, method = "sum")
    
    mm <- minmax(agg_local)
    if (all(is.nan(mm)) || all(is.na(mm))) {
      message("Species ", sp, ": 'sum' on local grid empty → fallback 'near'")
      agg_local <- resample(r_aligned, local_grid, method = "near")
    }
    
    # Final check
    mm <- minmax(agg_local)
    if (all(is.nan(mm)) || all(is.na(mm))) {
      message("Species ", sp, ": all resampling attempts failed → treating as zero range")
      total_range_110km <- 0L
      in_range_110 <- grid_110 * 0  # dummy
    } else {
      in_range_110 <- agg_local > 0
      
      # Map presence back to global (for consistency)
      overlap_cells <- which(!is.na(values(in_range_110)))
      global_cell_ids <- local_grid[overlap_cells]
      
      in_range_global <- rep(FALSE, ncell(grid_110))
      in_range_global[global_cell_ids] <- values(in_range_110)[overlap_cells]
      
      total_range_110km <- as.integer(sum(in_range_global, na.rm = TRUE))
      in_range_110 <- rast(grid_110)  # dummy raster
      values(in_range_110) <- in_range_global  # fill with mapped values
    }
  } else {
    # Success with global resampling
    in_range_110 <- agg > 0
    total_range_110km <- as.integer(global(in_range_110, "sum", na.rm = TRUE))
  }
  
  # ────────────────────────────────────────────────────────────────
  # Robust sampled cells calculation (matches visualize_species_coverage)
  # ────────────────────────────────────────────────────────────────
  
  # Rasterize deployments → count per cell
  dep_count <- rasterize(deploy_vect, grid_110, fun = "length", background = 0)
  
  # Presence in cell (≥1 deployment)
  dep_presence <- dep_count > 0
  
  # Sampled = in range AND has deployment
  sampled_raster <- in_range_110 & dep_presence
  
  # Number of sampled cells
  sampled_110km <- as.integer(global(sampled_raster, "sum", na.rm = TRUE))
  
  # Optional diagnostic (uncomment if needed)
  # message(sp, ": total_range = ", total_range_110km, " | sampled = ", sampled_110km)
  
  # Store result
  results <- rbind(results, list(sp, source_used, total_range_110km, sampled_110km))
}

# Post-processing
results[, coverage_pct := round(100 * sampled_110km / total_range_110km, 1)]
results[total_range_110km == 0, coverage_pct := NA_real_]

# Remove zero-range species (19 species still not calculating)
spp_to_remove <- results[results$total_range_110km < 0,]$sp_binomial
results <- results[total_range_110km > 0]
species_counts <- species_counts[!species_counts$sp_binomial %in% spp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% spp_to_remove,]

# View 
setorder(results, -coverage_pct)
head(results)

# Merge with species_counts
species_counts <- merge(species_counts,
                        results[, .(sp_binomial, total_range_110km, sampled_110km, coverage_pct)],
                        by = "sp_binomial",
                        all.x = TRUE)

# View
head(species_counts)


# Map species coverage function 
visualize_species_coverage <- function(sp) {
  
  # Load range raster
  file_name <- paste0(gsub(" ", "_", sp), ".tif")
  path <- file.path(raster_dir_1, file_name)
  if (!file.exists(path)) {
    path <- file.path(raster_dir_2, file_name)
  }
  if (!file.exists(path)) {
    stop(paste("No raster found for", sp, "in either directory"))
  }
  
  r <- rast(path)
  
  # Binary presence
  range_binary <- r > 0
  range_binary[is.na(range_binary)] <- FALSE
  
  # Bounding box for zoom
  bb_vec <- as.vector(ext(range_binary))
  
  # Aggregate range to 110 km grid (presence if any)
  range_110 <- aggregate(range_binary, fact = 110, fun = "max", na.rm = TRUE)
  range_110 <- resample(range_110, grid_110, method = "near")
  range_110[is.na(range_110)] <- 0
  range_110 <- range_110 > 0   # logical SpatRaster
  
  # Rasterize deployments to the grid (count per cell)
  deployment_count <- rasterize(deploy_vect, grid_110, fun = "length")
  deployment_count[is.na(deployment_count)] <- 0
  
  # Deployment presence (1 if any deployment, 0 otherwise)
  deployment_presence <- deployment_count > 0
  
  # Status raster (colored only where deployments exist, restricted to range)
  # 1 only if in range AND deployment, 0 otherwise
  status_110 <- deployment_presence * range_110   
  
  # Diagnostic
  cat("Status raster values summary:\n")
  print(table(values(status_110), useNA = "ifany"))
  status_factor <- as.factor(status_110)
  
  # Crop rasters and grid to the range bounding box
  range_binary_cropped <- crop(range_binary, bb_vec)
  status_factor_cropped <- crop(status_factor, bb_vec)
  
  presence_on_grid <- resample(r > 0, grid_110, method = "near")
  grid_cropped <- grid_110 * presence_on_grid   
  grid_cropped <- as.polygons(grid_cropped, na.rm = TRUE, dissolve = FALSE)
  
  vals <- extract(r, deploy_vect, method = "simple")[, 2]   
  deploy_cropped <- deploy_vect[!is.na(vals) & vals > 0, ]
  
  # Get the SSI (coverage_pct) for this species from species_counts
  ssi_value <- species_counts[sp_binomial == sp, coverage_pct]
  if (length(ssi_value) == 0 || is.na(ssi_value)) {
    ssi_value <- "NA"  
  } else {
    ssi_value <- round(ssi_value, 1)   
  }
  
  ggplot() +
    geom_spatraster(data = range_binary_cropped) +                  # species range
    geom_spatraster(data = status_factor_cropped, alpha = 0.65) +   # SII grid    
    scale_fill_manual(
      values = c("FALSE" = "white",           
                 "TRUE"  = "grey35",          
                 "0"     = "transparent",     
                 "1"     = "#4CAF50"),
      labels = c("FALSE" = NULL,  
                 "TRUE"  = NULL,   
                 "0"     = "No camera trap",
                 "1"     = "Camera trap present"),
      name = "110 km Cell Status",
      drop = FALSE) +
    
    geom_spatvector(
      data = deploy_cropped,
      color = "orange",
      size = 1.5,           # adjust size as needed
      alpha = 0.5,
      shape = 16            # solid circle
    ) + 
    
    geom_spatvector(data = grid_cropped, fill = NA, color = "grey35", linewidth = 0.3) +
    
    labs(title = "CT Deployments in Range", 
         subtitle = paste0(sp, ": SSI = ", ssi_value)) +
    theme(plot.subtitle = element_text(face = "italic"))
}

# Run it for target species 
(ssi_plot <- visualize_species_coverage("Canis rufus"))
  
# Save plot 
sp <- "Panthera_onca"
filename <- paste0("Model outputs/", sp, "/", sp, "-ssi_plot.jpg")
ggsave(filename, plot = ssi_plot, width = 8, height = 6, dpi = 600)


# Save products ---------------------------------------------------------------

# Quick check 
unique_species <- unique(species_counts$sp_binomial); length(unique_species) 
unique_species_alldat <- unique(all_dat$sp_binomial); length(unique_species_alldat)

species_counts[, intersect(c("class", "has_raster"), names(.SD)) := NULL]
setorder(species_counts, -record_count)
fwrite(species_counts, file = "WI data/species_counts.csv")
fwrite(all_dat, file = "WI data/all_dat.csv")


# Update products -------------------------------------------------------------

# Load generated file 
species_counts <- fread("WI data/species_counts.csv") %>% 
  dplyr::select(-"common_name")
all_dat <- fread("WI data/all_dat.csv")

# Load manually updated file -- fixed common names, added broad categorizations
species_updates <- fread("WI data/species_counts_updated.csv") %>% 
  dplyr::select(c("sp_binomial", "common_name", "broad_class", "max_kg"))

# Add new columns 
species_counts <- merge(species_counts, species_updates, by = "sp_binomial",
                        all.x = TRUE)
head(species_counts)

# Filtering: 
unique(species_counts$broad_class)

# Remove largely arboreal and semi-aquatic species species
sp_to_remove <- species_counts[species_counts$broad_class %in% 
                                 c("Seal/Sea Lion", "Bat", "Primate", "Semi-aquatic",
                                   "Arboreal omnivore", "Arboreal carnivore", "Arboreal rodent",
                                   "Arboreal marsupial", "Arboreal frugivore"),]$sp_binomial
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Remove species <= 2 kg
sp_to_remove <- species_counts[max_kg <= 2 & !is.na(max_kg), sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Remove species where pct_coverage < 4
sp_to_remove <- species_counts[coverage_pct < 4, sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Remove species where unique_deployments < 5
sp_to_remove <- species_counts[unique_deployments < 5, sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Remove species where total_range_110km == NA 
sp_to_remove <- species_counts[is.na(species_counts$total_range_110km),]$sp_binomial
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]


# Group selection: Bear
View(species_counts[species_counts$broad_class == "Bear",])
# -> all good: 10 bears; min coverage_pct = 4.5% 

# Group selection: Large felid 
View(species_counts[species_counts$broad_class == "Large felid",])
# -> all good: 10 large felids; min coverage_pct = 4%

# Group selection: Large canids
View(species_counts[species_counts$broad_class == "Large canid",])
# -> all good: 7 large canids, min coverage_pct = 4.8%

# Group selection: Hyena
View(species_counts[species_counts$broad_class == "Hyena",])
# -> all good: 3 hyenas; min coverage_pct = 4.9%

# Group selection: Even-toed ungulates
View(species_counts[species_counts$broad_class == "Even-toed ungulate",])

# -> 125 species; review continent by continent - aim for 2 per continent
table(species_counts[species_counts$broad_class == "Even-toed ungulate",]$primary_continent)

# Europe: 
View(species_counts[species_counts$broad_class == "Even-toed ungulate" &
                      species_counts$primary_continent == "Europe",])
# -> 2 Capra species, 2 Cervus species; reduce to 1 each for taxonomic diversity
sp_to_remove <- c("Capra ibex", "Cervus elaphus")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 6
sp_to_remove <- species_counts[species_counts$broad_class == "Even-toed ungulate" &
                                 species_counts$primary_continent == "Europe",][
                                   sample(.N, 8),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# S. America: 
View(species_counts[species_counts$broad_class == "Even-toed ungulate" & species_counts$primary_continent == "South America",])
# -> There are 7 Mazama spp -> select 3 of these taxonomic diversity
# -> Pick species of highest conservation concern based on IUCN RL status 
sp_to_remove <- c("Mazama gouazoubira", "Mazama nemorivaga", "Mazama rufina", "Mazama chunyi")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 8
sp_to_remove <- species_counts[species_counts$broad_class == "Even-toed ungulate" &
                                 species_counts$primary_continent == "South America",][
                                   sample(.N, 8),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# N. America: 
View(species_counts[species_counts$broad_class == "Even-toed ungulate" & species_counts$primary_continent == "North America",])
# -> For some reason, "Hippotragus niger" listed as NAm when African; move
species_counts[species_counts$sp_binomial == "Hippotragus niger",]$primary_continent <- "Africa"
# -> Now 10 spp; all look good  
# -> 3 Odocoileus species; select 1 for taxonomic diversity
sp_to_remove <- c("Odocoileus virginianus", "Odocoileus pandora")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 6
sp_to_remove <- species_counts[species_counts$broad_class == "Even-toed ungulate" &
                                 species_counts$primary_continent == "North America",][
                                   sample(.N, 6),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Asia: 
View(species_counts[species_counts$broad_class == "Even-toed ungulate" & species_counts$primary_continent == "Asia",])
# -> There are 4 Muntiacus rooseveltorums? remove 
sp_to_remove <- "Muntiacus rooseveltorum" 
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> Remove species with coverage_pct < 5% &/or deployments < 10 
sp_to_remove <- c("Ovis ammon", "Hydropotes inermis", "Boselaphus tragocamelus", "Capra sibirica", 
                  "Tragulus nigricans")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> There are 6 Tragelaphus spp, 2 Potamochoerus spp, 2 Kobus spp, 11 Cephalophus spp -> select 1 of each for taxonomic diversity
# -> Pick species of highest conservation concern based on IUCN RL; if same, pick randomly
sp_to_remove <- c("Bos gaurus", "Capricornis crispus", "Moschiola indica", "Muntiacus atherodes", "Muntiacus muntjak", "Muntiacus vaginalis", "Sus scrofa", "Sus ahoenobarbus", "Tragulus napu")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> The rest look good; randomly sample 10 Asian species
sp_to_remove <- species_counts[species_counts$broad_class == "Even-toed ungulate" &
                                 species_counts$primary_continent == "Asia",][sample(.N, 8),
                                                                              sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> The rest look good; randomly remove 8 species 
sp_to_remove <- species_counts[species_counts$broad_class == "Even-toed ungulate" &
                                 species_counts$primary_continent == "Asia",][sample(.N, 8),
                                                                              sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Africa:
View(species_counts[species_counts$broad_class == "Even-toed ungulate" & species_counts$primary_continent == "Africa",])
# -> There are 4 Cephalophus ogilbyis? remove
sp_to_remove <- "Cephalophus ogilbyi" 
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> Remove species with coverage_pct < 5% &/or deployments < 10 
sp_to_remove <- c("Neotragus pygmaeus", "Redunca redunca", "Phacochoerus africanus", 
                  "Redunca arundinum", "Giraffa camelopardalis", "Sylvicapra grimmia", 
                  "Madoqua guentheri")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> There are 6 Tragelaphus spp, 2 Potamochoerus spp, 2 Kobus spp, 11 Cephalophus spp -> select 1 of each for taxonomic diversity
# -> Pick species of highest conservation concern based on IUCN RL; if same, pick randomly
sp_to_remove <- c("Tragelaphus oryx", "Tragelaphus spekii", "Tragelaphus strepsiceros", "Potamochoerus larvatus", "Kobus ellipsiprymnus", "Cephalophus callipygus", "Cephalophus dorsalis", "Cephalophus jentinki", "Cephalophus leucogaster", "Cephalophus natalensis", "Cephalophus nigrifrons", "Cephalophus silvicultor", "Cephalophus spadix", "Cephalophus weynsi", "Cephalophus zebra")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> All look good; randomly sample 10 African species
sp_to_remove <- species_counts[species_counts$broad_class == "Even-toed ungulate" &
                                 species_counts$primary_continent == "Africa",][sample(.N, 18),
                                                                              sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> All look good; randomly remove 8 species 
sp_to_remove <- species_counts[species_counts$broad_class == "Even-toed ungulate" &
                                 species_counts$primary_continent == "Africa",][sample(.N, 8),
                                                                                sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Group selection: Odd-toed ungulate
View(species_counts[species_counts$broad_class == "Odd-toed ungulate",])
# -> all good: 10 odd-toed ungulates; min coverage_pct = 4%

# Group selection: Small felids
View(species_counts[species_counts$broad_class == "Small felid",])

# -> 18 species; review continent by continent - aim for 2 per continent
table(species_counts[species_counts$broad_class == "Small felid",]$primary_continent)

# Asia: 
View(species_counts[species_counts$broad_class == "Small felid" & species_counts$primary_continent == "Asia",])
# -> 2 Catopuma spp, remove 1: 
sp_to_remove <- "Catopuma temminckii"
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 2
sp_to_remove <- species_counts[species_counts$broad_class == "Small felid" &
                                 species_counts$primary_continent == "Asia",][sample(.N, 2),
                                                                                sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# South America: 
View(species_counts[species_counts$broad_class == "Small felid" & species_counts$primary_continent == "South America",])
# -> all Leopardus; select to keep Leopardus guigna and Leopardus guttulus as most threatened 
sp_to_remove <- c("Leopardus colocola", "Leopardus geoffroyi", "Leopardus pardalis",
                  "Leopardus tigrinus", "Leopardus wiedii")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Group selection: Small canids
View(species_counts[species_counts$broad_class == "Small canid",])

# -> 16 species, aim for 2 per continent (10 total) 
table(species_counts[species_counts$broad_class == "Small canid",]$primary_continent)

# S. America: 
View(species_counts[species_counts$broad_class == "Small canid" & species_counts$primary_continent == "South America",])
# -> 5 Lycalopex species; select 1 for taxonomic diversity
sp_to_remove <- c("Lycalopex culpaeus", "Lycalopex griseus", "Lycalopex gymnocercus", 
                  "Lycalopex vetulus")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 2
sp_to_remove <- species_counts[species_counts$broad_class == "Small canid" &
                                 species_counts$primary_continent == "South America",][
                                   sample(.N, 2),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Group selection: Elephant
View(species_counts[species_counts$broad_class == "Elephant",])
# -> all good: 3 elephants, min coverage_pct = 5.9%

# Group selection: Marsupials 
View(species_counts[species_counts$broad_class %in% c("Large marsupial", "Small marsupial"),])
# -> all good: 10 large marsupials, min coverage_pct = 8.6%
# REDO: get large down to 5, get small down to 5 --> 
# -> all large marsupials from Oceania; all look good; randomly remove 5
sp_to_remove <- species_counts[species_counts$broad_class == "Large marsupial",][
                                   sample(.N, 5),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> small marsupials: 
View(species_counts[species_counts$broad_class == "Small marsupial",])
table(species_counts[species_counts$broad_class == "Small marsupial",]$primary_continent)
# -> get 2 on Oceania, 2 on S. America

# Oceania: 
View(species_counts[species_counts$broad_class == "Small marsupial" &
                      species_counts$primary_continent == "Oceania",])
# -> 2 Notamacropus species, 3 Petrogale species, 3 Thylogale species, 3 Trichosurus species; select 1 of each for taxonomic diveristy 
sp_to_remove <- c("Notamacropus eugenii", "Petrogale brachyotis", "Petrogale lateralis", "Thylogale stigmatica", "Thylogale thetis", "Trichosurus caninus", "Trichosurus cunninghami")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all look good; randomly remove 12
sp_to_remove <- species_counts[species_counts$broad_class == "Small marsupial" & species_counts$primary_continent == "Oceania",][
  sample(.N, 12),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# South America: 
View(species_counts[species_counts$broad_class == "Small marsupial" &
                      species_counts$primary_continent == "South America",])
# -> all Didelphis; randomly remove 1 
sp_to_remove <- species_counts[species_counts$broad_class == "Small marsupial" & species_counts$primary_continent == "South America",][
  sample(.N, 1),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Rename
species_counts[species_counts$broad_class %in% c("Small marsupial", "Large marsupial"),]$broad_class <- "Marsupial"

# Group selection: Rodent
View(species_counts[species_counts$broad_class == "Rodent",])

# -> 32 species; review continent by continent - aim for 2 per continent
table(species_counts[species_counts$broad_class == "Rodent",]$primary_continent)

# Africa: 
View(species_counts[species_counts$broad_class == "Rodent" & species_counts$primary_continent == "Africa",])
# -> 5 Hystrix species; select 1 for taxonomic diversity
sp_to_remove <- "Hystrix africaeaustralis"
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 1
sp_to_remove <- species_counts[species_counts$broad_class == "Rodent" &
                                 species_counts$primary_continent == "Africa",][
                                   sample(.N, 1),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Asia: 
View(species_counts[species_counts$broad_class == "Rodent" & species_counts$primary_continent == "Asia",])
# -> 3 Hystrix species, 2 Marmota species; select 1 of each for taxonomic diversity
sp_to_remove <- c("Hystrix brachyura", "Hystrix crassispinis", "Marmota himalayana")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 3
sp_to_remove <- species_counts[species_counts$broad_class == "Rodent" &
                                 species_counts$primary_continent == "Asia",][
                                   sample(.N, 3),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# N. America:
View(species_counts[species_counts$broad_class == "Rodent" & species_counts$primary_continent == "North America",])
# -> 2 Marmota species; select 1 for taxonomic diversity
sp_to_remove <- "Marmota caligata"
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 4
sp_to_remove <- species_counts[species_counts$broad_class == "Rodent" &
                                 species_counts$primary_continent == "North America",][
                                   sample(.N, 4),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# S. America: 
View(species_counts[species_counts$broad_class == "Rodent" & species_counts$primary_continent == "South America",])
# -> 6 Dasyprocta species, 2 Hydrochoerus hydrochaeris; select 1 of each for taxonomic diversity
sp_to_remove <- c("Dasyprocta fuliginosa", "Dasyprocta leporina", "Dasyprocta prymnolopha",
                  "Dasyprocta croconota", "Hydrochoerus hydrochaeris")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 4
sp_to_remove <- species_counts[species_counts$broad_class == "Rodent" &
                                 species_counts$primary_continent == "South America",][
                                   sample(.N, 4),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Group selection: Smalls
View(species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore"),])
# -> Remove species with coverage_pct < 5% &/or deployments < 10 
sp_to_remove <- c("Lepus victoriae", "Lepus tolai", "Mungos mungo", "Sorex vagrans", "Genetta victoriae", "Choloepus didactylus", "Neurotrichus gibbsii", "Dendrohyrax dorsalis", "Sorex cinereus", "Microtus pennsylvanicus", "Microtus ochrogaster")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# -> 32 species; review continent by continent - aim for 2 per continent
table(species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore"),]$primary_continent)

# Africa:
View(species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore") & species_counts$primary_continent == "Africa",])
# -> 3 Bdeogale species, 2 Dendrohyrax species, 2 Genetta species, 3 Rhynchocyon species; select 1 of each for taxonomic diversity
sp_to_remove <- c("Bdeogale jacksoni", "Bdeogale crassicauda", "Dendrohyrax arboreus", "	
Genetta maculata", "Rhynchocyon cirnei", "Rhynchocyon udzungwensis")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 11
sp_to_remove <- species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore") & species_counts$primary_continent == "Africa",][
                                   sample(.N, 11),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Asia:
View(species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore") & species_counts$primary_continent == "Asia",])
# -> 3 Lepus species, 3 Melogale species, 2 Ochotona species, 5 Tupaia species, 3 Urva species, 4 Viverra species; select 1 of each for taxonomic diversity
sp_to_remove <- c("Lepus brachyurus", "Lepus nigricollis", "Melogale moschata", "Melogale personata", "Ochotona gloveri", "Tupaia belangeri", "Tupaia glis", "Tupaia palawanensis", "Tupaia tana", "Urva smithii", "Urva brachyura", "Viverra tangalunga", "Viverra zibetha", "Viverricula indica")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 12
sp_to_remove <- species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore") & species_counts$primary_continent == "Asia",][
  sample(.N, 12),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Europe: 
View(species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore") & species_counts$primary_continent == "Europe",])
# -> accidently classified Genetta genetta as European (Africa); remove
sp_to_remove <- "Genetta genetta"
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> 2 Lepus species; select 1 for taxonomic diversity
sp_to_remove <- "Lepus granatensis"
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 3
sp_to_remove <- species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore") & species_counts$primary_continent == "Europe",][
  sample(.N, 3),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# N. America
View(species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore") & species_counts$primary_continent == "North America",])
# -> 4 Lepus species; 2 Mephitis species, 2 Microtus species, 8 Sylvilagus species; select 1 of each for taxonomic diversity
sp_to_remove <- c("Lepus townsendii", "Lepus americanus", "Lepus alleni", "Mephitis macroura", "Microtus californicus", "Sylvilagus aquaticus", "Sylvilagus audubonii", "Sylvilagus bachmani", "Sylvilagus floridanus", "Sylvilagus nuttallii", "Sylvilagus obscurus", "Sylvilagus palustris")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 10
sp_to_remove <- species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore") & species_counts$primary_continent == "North America",][
  sample(.N, 10),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# South America
View(species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore") & species_counts$primary_continent == "South America",])
# -> 2 Conepatus species, 2 Galictis species; select 1 of each for taxonomic diversity
sp_to_remove <- c("Conepatus chinga", "Galictis vittata")
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]
# -> all others look good, randomly remove 9
sp_to_remove <- species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore") & species_counts$primary_continent == "South America",][
  sample(.N, 9),sp_binomial]
species_counts <- species_counts[!species_counts$sp_binomial %in% sp_to_remove,]
all_dat <- all_dat[!all_dat$sp_binomial %in% sp_to_remove,]

# Rename
species_counts[species_counts$broad_class %in% c("Small carnivore", "Small mammal", "Small omnivore"),]$broad_class <- "Small mammals"

# Quick check
length(unique(species_counts$sp_binomial))
length(unique(all_dat$sp_binomial))

duplicated(species_counts$sp_binomial)
unique(species_counts$sp_binomial[duplicated(species_counts$sp_binomial)])
species_counts[species_counts$sp_binomial == "Ursus arctos",]
species_counts <- species_counts[!duplicated(species_counts$sp_binomial), ]

## Save! 
fwrite(species_counts, file = "WI data/species_counts.csv")
fwrite(all_dat, file = "WI data/all_dat.csv")
